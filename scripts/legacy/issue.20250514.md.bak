# MicDysphagiaFramework 開發議題 (20250514, 已開發完成)

## 功能需求概述

本文件列出三個需要開發的功能，以增強 MicDysphagiaFramework 的數據追蹤與分析能力。

## 功能 1: 完整保存訓練/驗證/測試資料集資訊

### 目的
在每次執行 `run_experiments.py` 時，完整保存訓練、驗證和測試集中使用的所有資料，以便後續分析模型在不同資料集上的表現差異。

### 技術實現
1. 在 `SaveManager` 中新增函數，專門用於保存資料集資訊
2. 在 `run_experiments.py` 中，在資料集載入後，立即保存資料集的相關資訊
3. 保存格式應包含：
   - 資料集大小
   - 資料分布統計 (類別分布、特徵統計等)
   - 資料集分割方式 (如果使用了特定的分割策略)
   - 資料預處理參數
   - 資料的檔案路徑清單 (方便追蹤)

### 預期結果
在實驗結果目錄中，新增 `datasets` 子目錄，包含：
```
datasets/
  ├── train_dataset_info.pt    # 訓練集資訊
  ├── val_dataset_info.pt      # 驗證集資訊
  ├── test_dataset_info.pt     # 測試集資訊
  └── dataset_statistics.json  # 綜合統計資訊
```

## 功能 2: 特定層的特徵向量保存與相似度分析

### 目的
捕獲模型在指定層的特徵向量表示，以便進行餘弦相似度分析和 t-SNE 視覺化，分析模型對不同資料點的處理方式和學習方向。

### 技術實現
1. 擴展 `hook_bridge.py` 中的 `ActivationCaptureHook` 類，增加指定 epoch 和層的功能
2. 在 `run_experiments.py` 中，添加配置選項允許指定要捕獲的層和 epoch
3. 實現餘弦相似度計算和 t-SNE 視覺化的輔助函數
4. 針對捕獲的特徵向量，建議優先考慮以下層：
   - 對於 CNN 模型：
     - 最後一個卷積層輸出 (通常為 `backbone.7` 或類似命名)
     - 池化層之後、全連接層之前的特徵圖 (如 `backbone.9`)
     - 可考慮中間層特徵圖 (如 `backbone.4`) 以分析特徵演化過程
   - 對於 FCNN 模型：
     - 倒數第二個全連接層 (如 `fc_layers.2`)
     - 最後一個隱藏層 (如 `head.0`)
     - 考慮捕獲多個隱藏層以分析特徵轉換過程
   - 對於 Swin-Transformer 模型：
     - 最後一個 Transformer 層的輸出 (如 `layers.3.blocks.1`)
     - 最後一個 Patch Merging 層輸出
     - 注意力權重矩陣 (用於分析模型關注區域)
   - 對於 ResNet 模型：
     - 最後一個 ResBlock 輸出 (如 `layer4`)
     - Global Average Pooling 層輸出
     - 瓶頸層 (bottleneck) 輸出
   - 對於混合模型：倒數第二個全連接層 (特徵提取後、分類前)

### 預期結果
在實驗結果目錄中，新增 `feature_vectors` 子目錄：
```
feature_vectors/
  ├── epoch_10/
  │   ├── layer_conv5_features.pt       # 特定層的特徵向量
  │   ├── cosine_similarity_matrix.pt   # 餘弦相似度矩陣
  │   └── tsne_coordinates.json         # t-SNE 座標
  ├── epoch_20/
  │   └── ...
  └── feature_analysis.json             # 特徵分析摘要
```

## 實作建議

### 關於餘弦相似度分析
餘弦相似度分析可以幫助我們理解：
1. 同類別樣本在特徵空間中的聚集程度
2. 不同類別樣本的區分度
3. 模型訓練過程中，特徵表示的穩定性和變化趨勢

建議計算以下幾種餘弦相似度：
- 同類別樣本間的平均餘弦相似度
- 不同類別樣本間的平均餘弦相似度
- 每個樣本與其類別質心的餘弦相似度
- 訓練前後同一樣本特徵向量的餘弦相似度 (需要保存初始特徵)

### 關於選擇合適的層
針對第三個功能，選擇合適的層對於分析至關重要：

1. **分類任務**：
   - 最適合的是倒數第二層 (分類層之前的特徵提取層)
   - 這一層包含了高級語義特徵，同時保留了空間/時間信息

2. **回歸任務**：
   - 同樣是倒數第二層，但可能需要更多實驗確定最佳層

3. **模型特定建議**：
   - ResNet: 最後一個 ResBlock 輸出
   - Transformer: 最後一個 Transformer 層的輸出
   - FCNN: 最後一個隱藏層

建議在配置文件中允許靈活指定要分析的層，並提供一個默認推薦層列表。

## 後續步驟
1. 優先實現功能 1，確保資料集追蹤完整
2. 實現功能 3 中的特徵向量捕獲部分
3. 完成功能 2 的批次資料收集
4. 開發相似度分析和視覺化工具
