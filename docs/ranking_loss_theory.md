# 排序損失函數的數學理論基礎

本文檔詳細闡述排序損失函數的數學理論基礎，幫助理解這些函數如何在吞嚥障礙評估中優化模型的排序能力。

## 目錄

- [概述](#概述)
- [成對排序損失函數](#成對排序損失函數)
- [列表排序損失函數](#列表排序損失函數)
- [排序評估指標及優化](#排序評估指標及優化)
- [損失函數選擇策略](#損失函數選擇策略)

## 概述

排序學習（Learning to Rank）旨在訓練模型對項目進行正確的排序，而非簡單的分類或迴歸。在吞嚥障礙評估中，這對於根據多種臨床特徵準確評估患者的嚴重程度至關重要。

排序學習方法主要分為三類：
- **點態方法（Pointwise）**：將排序問題轉換為迴歸或分類問題
- **成對方法（Pairwise）**：學習項目之間的相對順序關係
- **列表方法（Listwise）**：直接優化整個排序列表

## 成對排序損失函數

### 邊際排序損失 (Margin Ranking Loss)

數學表達式：
$$L_{margin}(s_i, s_j, y_{ij}) = \max(0, -y_{ij} \cdot (s_i - s_j) + \text{margin})$$

其中：
- $s_i, s_j$ 是樣本 $i$ 和 $j$ 的預測分數
- $y_{ij} \in \{-1, 1\}$ 表示 $i$ 是否應該排在 $j$ 之前
- margin 是期望維持的最小分數差距

**數學原理**：邊際排序損失要求正確排序的樣本對之間保持最小的分數差距（margin）。當差距小於 margin 時產生損失，促使模型學習更加明確的排序關係。

在梯度下降中，該損失提供的梯度為：
$$\nabla_{s_i}L = \begin{cases} 
-y_{ij} & \text{if } -y_{ij} \cdot (s_i - s_j) + \text{margin} > 0 \\
0 & \text{otherwise}
\end{cases}$$

### RankNet 損失

RankNet 基於概率方法建模排序關係。首先定義項目 $i$ 排在 $j$ 之前的概率：

$$P_{ij} = \frac{1}{1 + e^{-\sigma(s_i - s_j)}}$$

損失函數為交叉熵：

$$L_{ranknet}(s_i, s_j, y_{ij}) = -\bar{P}_{ij}\log(P_{ij}) - (1-\bar{P}_{ij})\log(1-P_{ij})$$

其中：
- $\bar{P}_{ij}$ 是真實的排序關係概率（通常為 0 或 1）
- $\sigma$ 是 sigmoid 函數的縮放因子

**數學原理**：RankNet 通過概率框架處理排序關係，將問題轉化為估計一個項目應排在另一個項目前面的概率。這允許模型處理部分排序或不確定的排序關係。

對於明確的排序關係（$\bar{P}_{ij} = 1$），損失簡化為：

$$L_{ranknet}(s_i, s_j, 1) = \log(1 + e^{-\sigma(s_i - s_j)})$$

### 保真度損失 (Fidelity Loss)

基於量子保真度概念：

$$L_{fidelity}(s_i, s_j, y_{ij}) = 1 - \sqrt{P_{ij} \cdot \bar{P}_{ij} + \sqrt{(1-P_{ij})(1-\bar{P}_{ij})}}$$

**數學原理**：保真度損失來源於量子信息理論，測量兩個概率分布的相似度。相比交叉熵，它有更平滑的梯度，在處理噪聲較大的排序數據時更加穩健。

## 列表排序損失函數

### ListMLE 損失

ListMLE（List Maximum Likelihood Estimation）通過最大化正確排序的概率來優化模型。

對於一個排序列表 $\pi$，其概率定義為：

$$P(\pi|s) = \prod_{i=1}^{m} \frac{\exp(s_{\pi(i)})}{\sum_{j=i}^{m} \exp(s_{\pi(j)})}$$

損失函數為負對數似然：

$$L_{listmle}(s, \pi) = -\log P(\pi|s) = -\sum_{i=1}^{m} \left( s_{\pi(i)} - \log\sum_{j=i}^{m} \exp(s_{\pi(j)}) \right)$$

**數學原理**：ListMLE 將排序問題作為一個序列決策過程，在每一步選擇下一個最佳項目。它使用 Plackett-Luce 模型為完整排序分配概率，並通過最大化觀察到的排序序列的概率來訓練模型。

### 近似 NDCG 損失 (ApproxNDCG Loss)

NDCG（Normalized Discounted Cumulative Gain）是一種常用的排序評估指標：

$$NDCG@k = \frac{1}{Z} \sum_{i=1}^{k} \frac{2^{r_{\pi(i)}} - 1}{\log_2(i+1)}$$

其中 $r_{\pi(i)}$ 是位置 $i$ 項目的相關性，$Z$ 是正規化因子。

由於排序操作不可微，ApproxNDCG 使用 softmax 函數進行平滑近似：

$$\hat{\pi}_i = \sum_{j=1}^{n} j \cdot \frac{\exp(s_i/\tau)}{\sum_{k=1}^{n} \exp(s_k/\tau)}$$

損失函數定義為：

$$L_{approxNDCG}(s, r) = 1 - \frac{\sum_{i=1}^{k} \frac{2^{r_i} - 1}{\log_2(\hat{\pi}_i+1)}}{\sum_{i=1}^{k} \frac{2^{r_i} - 1}{\log_2(i+1)}}$$

**數學原理**：ApproxNDCG 通過可微分近似直接優化 NDCG 評估指標。它使用 softmax 函數建立預測分數與排名位置之間的連續映射，使得梯度能夠有效傳播。

### LambdaRank 損失

LambdaRank 不直接定義損失函數，而是通過重新加權的梯度來優化排序指標：

$$\lambda_{ij} = -\sigma \cdot (1-S_{ij}) \cdot |\Delta NDCG_{ij}|$$

其中：
- $S_{ij} = \frac{1}{1+e^{-\sigma(s_i-s_j)}}$
- $\Delta NDCG_{ij}$ 是交換項目 $i$ 和 $j$ 引起的 NDCG 變化

**數學原理**：LambdaRank 是一種基於梯度的方法，它的創新在於不直接定義損失函數，而是直接推導出優化排序指標所需的梯度方向。通過加入 $\Delta NDCG$ 因子，它使得對排序結果影響更大的項目對獲得更大的梯度調整。

## 排序評估指標及優化

常用的排序評估指標包括：

### NDCG (Normalized Discounted Cumulative Gain)

$$NDCG@k = \frac{DCG@k}{IDCG@k}$$

$$DCG@k = \sum_{i=1}^{k} \frac{2^{r_i} - 1}{\log_2(i+1)}$$

### MAP (Mean Average Precision)

$$MAP = \frac{1}{|Q|} \sum_{q=1}^{|Q|} \frac{1}{m_q} \sum_{k=1}^{n_q} P(k) \cdot rel(k)$$

其中 $P(k)$ 是前 $k$ 個結果的精確度，$rel(k)$ 表示第 $k$ 個結果是否相關。

### Kendall's Tau

測量兩個排序間的一致性：

$$\tau = \frac{P - Q}{P + Q}$$

其中 $P$ 是一致對數，$Q$ 是不一致對數。

**優化策略**：
1. **梯度加權**：根據評估指標變化調整梯度，如 LambdaRank
2. **可微近似**：建立評估指標的可微分近似，如 ApproxNDCG
3. **代理損失**：設計與評估指標高度相關的代理損失函數

## 損失函數選擇策略

在吞嚥障礙評估場景中選擇排序損失函數時應考慮：

### 數據特性考量

- **數據規模**：小型數據集可能更適合使用成對方法，大型數據集可以考慮列表方法
- **標註類型**：部分排序或評分標註適合成對方法，完整排序標註適合列表方法
- **噪音水平**：高噪音數據集可能需要更穩健的損失函數，如保真度損失

### 任務目標考量

- **強調頂部準確率**：使用 ApproxNDCG 或 LambdaRank 直接優化 NDCG@k
- **整體排序一致性**：ListMLE 或 RankNet 可能更適合
- **臨床安全關注**：可設計特殊加權方案，對高風險誤判施加更高懲罰

### 計算效率考量

- 成對方法計算複雜度為 $O(n^2)$
- 列表方法計算複雜度從 $O(n \log n)$ 到 $O(n^2)$ 不等
- 在大規模應用中，可考慮使用採樣技術減少計算量

### 最佳實踐

1. **組合損失函數**：通過加權組合多種損失函數，可以平衡各自的優勢
2. **自適應權重**：根據訓練過程中的性能動態調整不同損失函數的權重
3. **驗證驅動選擇**：通過交叉驗證比較不同損失函數在特定數據集上的性能

在吞嚥障礙評估應用中，我們建議以臨床相關性為導向，選擇能夠最準確識別臨床上重要區分（如正常/輕度/中度/重度吞嚥障礙）的損失函數。 