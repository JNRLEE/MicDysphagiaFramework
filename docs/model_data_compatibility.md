# 模型與數據類型兼容性說明

## 概述

MicDysphagiaFramework 框架支持多種數據類型與模型架構的無縫兼容。本文檔詳細說明不同模型架構如何處理各種類型的輸入數據，以及實現兼容性的數據轉換原理。

## 兼容性矩陣

下表列出了各個模型對不同數據類型的兼容性：

| 模型 | 音頻 (Audio) | 頻譜圖 (Spectrogram) | 特徵向量 (Feature Vector) |
|------|-------------|---------------------|------------------------|
| Swin Transformer | ✅ | ✅ | ✅ |
| FCNN | ✅ | ✅ | ✅ |
| CNN | ✅ | ✅ | ✅ |
| ResNet | ✅ | ✅ | ✅ |

## 數據適配原則

框架實現全兼容性的核心在於自動數據適配機制，主要原則如下：

1. **數據維度轉換**：根據模型需求對輸入數據進行維度轉換，確保與模型輸入層匹配。
2. **格式標準化**：不同類型的數據會被標準化為模型可接受的格式。
3. **自動兼容性檢測**：系統會自動檢測數據與模型的兼容性，並執行必要的轉換。
4. **批次處理適配**：支持在批次(batch)處理中對數據進行適當轉換。

## 數據轉換流程

### 音頻到頻譜圖的轉換（Audio to Spectrogram）

1. **轉換原理**：使用短時傅立葉變換(STFT)將時域音頻信號轉換為時頻域表示。
2. **數學描述**：對於音頻序列 $x[n]$，轉換為頻譜圖 $X[k, m]$，其中 $k$ 表示頻率索引，$m$ 表示時間幀。
3. **實現細節**：
   - 將原始音頻重塑為合適的批次格式
   - 應用STFT進行轉換
   - 轉換為對數頻譜圖以增強視覺對比度
   - 調整通道數以匹配視覺模型要求（通常從1通道擴展至3通道）

### 頻譜圖到特徵向量的轉換（Spectrogram to Feature Vector）

1. **轉換原理**：將2D頻譜圖數據展平或萃取特徵，轉換為1D特徵向量。
2. **實現細節**：
   - 對於FCNN等需要向量輸入的模型，將頻譜圖展平為一維向量
   - 根據目標模型的輸入維度要求調整特徵向量長度（截斷或填充）
   - 保持批次維度不變，僅轉換數據表示形式

### 特徵向量到2D表示的轉換（Feature Vector to 2D Representation）

1. **轉換原理**：將1D特徵向量重塑為2D圖像格式，以適應CNN等視覺模型。
2. **實現細節**：
   - 將特徵向量重新排列為2D矩陣
   - 調整空間尺寸以匹配視覺模型的輸入要求（如224x224）
   - 根據需要擴展通道維度（通常轉換為3通道）

### 批次適配考慮（Batch Adaptation）

1. **批次一致性**：確保轉換後的數據在批次維度上保持一致。
2. **維度順序**：根據PyTorch約定，維度順序為 [batch_size, channels, height, width]。
3. **記憶體效率**：在處理大批次數據時，採用記憶體高效的轉換方法。

## 模型特定適配說明

### Swin Transformer

1. **輸入要求**：期望3通道2D圖像輸入，標準尺寸為224x224。
2. **適配方法**：
   - 音頻數據首先轉換為頻譜圖，然後調整至3通道
   - 頻譜圖直接調整通道數和空間尺寸
   - 特徵向量重塑為2D格式並擴展至3通道

### FCNN (Fully Connected Neural Network)

1. **輸入要求**：期望1D特徵向量，具有固定的特徵維度。
2. **適配方法**：
   - 音頻數據通過特徵提取轉換為特徵向量
   - 頻譜圖通過展平轉換為向量
   - 特徵向量直接調整維度以匹配模型要求

### CNN (Convolutional Neural Network)

1. **輸入要求**：期望多通道2D圖像輸入。
2. **適配方法**：
   - 音頻數據首先轉換為頻譜圖
   - 頻譜圖調整通道數和空間尺寸
   - 特徵向量重塑為2D格式

### ResNet

1. **輸入要求**：期望3通道2D圖像輸入，標準尺寸為224x224。
2. **適配方法**：
   - 適配方式與Swin Transformer類似
   - 使用標準化後的圖像格式進行處理

## 維度轉換數學原理

### 展平操作（Flattening）

將多維張量 $X \in \mathbb{R}^{C \times H \times W}$ 轉換為向量 $y \in \mathbb{R}^{CHW}$：

$y_i = X_{c,h,w}$，其中 $i = c \cdot (H \cdot W) + h \cdot W + w$

### 重塑操作（Reshaping）

將向量 $y \in \mathbb{R}^{N}$ 轉換為2D矩陣 $Z \in \mathbb{R}^{H \times W}$，其中 $H \cdot W = N$：

$Z_{h,w} = y_i$，其中 $i = h \cdot W + w$

## 批次處理考慮事項

1. **BatchNorm問題**：在評估模式下使用模型以避免單樣本批次中的BatchNorm問題。
2. **維度一致性**：確保批次中的所有樣本維度一致。
3. **數據正規化**：根據模型期望進行適當的數據正規化處理。
4. **記憶體效率**：特別是對於大型頻譜圖，採用記憶體效率高的轉換方法。

## 預訓練模型的通道匹配

對於預訓練視覺模型（如Swin Transformer和ResNet），通常期望3通道輸入。框架採用以下策略處理通道不匹配：

1. **單通道到多通道**：將單通道數據（如灰度頻譜圖）複製到所有通道。
2. **多通道到3通道**：對於超過3通道的數據，選擇前3個通道或進行通道合併。

## 結論

MicDysphagiaFramework的數據適配機制確保任何支持的模型都能處理任何類型的輸入數據，大大簡化了研究者處理不同數據格式的複雜性。這種靈活性使研究人員能夠專注於模型開發和評估，而不必擔心數據格式轉換的技術細節。 